{% extends "base.html" %}
{% block title %}Чат с {{ recipient.fullname }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="user-avatar me-2" data-user-id="{{ recipient.id }}">
                        <i class="bi bi-person-fill"></i>
                    </div>
                    <h5 class="mb-0">Чат с {{ recipient.fullname }}</h5>
                </div>
                <div>
                    <a href="{{ url_for('user_profile', username=recipient.username) }}" class="btn btn-sm btn-outline-secondary me-1">
                        <i class="bi bi-person"></i> Профиль
                    </a>
                    <a href="{{ url_for('inbox') }}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-arrow-left"></i> Назад
                    </a>
                </div>
            </div>

            <div class="card-body" style="max-height: 60vh; overflow-y: auto;" id="message-box">
                <!-- Сообщения будут загружены через JavaScript -->
            </div>

            <div class="card-footer">
                <div class="alert alert-warning d-none mb-3" id="connection-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Потеряно соединение с сервером. Пытаемся подключиться...
                </div>

                <form id="message-form">
                    <div class="input-group mb-3">
                        <textarea class="form-control" name="content" rows="2" id="message-input"
                                 placeholder="Введите сообщение..." required></textarea>
                        <button class="btn btn-primary" type="submit">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                </form>

                <form id="file-form" class="mt-3">
                    <div class="input-group">
                        <input type="file" class="form-control" id="file-input">
                        <button class="btn btn-outline-secondary" type="button" id="file-button">
                            <i class="bi bi-paperclip"></i> Прикрепить файл
                        </button>
                    </div>
                    <small class="text-muted">Файлы хранятся не более {{ config['FILE_LIFETIME'] }} дней</small>
                    <div class="progress mt-2 d-none" id="file-progress" style="height: 5px;">
                        <div class="progress-bar" role="progressbar" style="width: 0%;"></div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Initializing chat...");

        // Сохраняем контекст чата
        window.chatContext = {
            currentUserId: {{ current_user.id }},
            recipientId: {{ recipient.id }},
            recipientName: "{{ recipient.fullname }}"
        };

        // Элементы UI
        const messageBox = document.getElementById('message-box');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const fileButton = document.getElementById('file-button');
        const connectionWarning = document.getElementById('connection-warning');

        // Добавляем обработчик клавиш для textarea
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Загружаем историю сообщений
        loadChatHistory();

        // Обработчики событий
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            sendMessage();
        });
        fileButton.addEventListener('click', handleFileUpload);

        // Инициализация WebSocket
        initWebSocket();

        // Функция загрузки истории сообщений
        function loadChatHistory() {
            fetch(`/chat/history/${chatContext.recipientId}`)
                .then(response => response.json())
                .then(messages => {
                    messageBox.innerHTML = ''; // Очищаем контейнер
                    messages.forEach(msg => {
                        addMessageToChat({
                            id: msg.id,
                            sender_id: msg.sender_id,
                            recipient_id: msg.recipient_id,
                            sender_name: msg.sender_name,
                            content: msg.content,
                            timestamp: msg.timestamp,
                            is_read: msg.is_read,
                            files: msg.files
                        }, false); // Не временное сообщение
                    });
                    // Прокручиваем вниз
                    messageBox.scrollTop = messageBox.scrollHeight;

                    // Помечаем все входящие сообщения как прочитанные
                    markAllMessagesAsRead();
                })
                .catch(error => {
                    console.error('Ошибка загрузки истории:', error);
                });
        }

        // Функция инициализации WebSocket
        function initWebSocket() {
            if (window.socket) {
                console.log("WebSocket available, setting up handlers");

                // Обработка новых сообщений
                window.socket.on('new_message', function(data) {
                    console.log("New message received:", data);

                    // Проверяем, относится ли сообщение к текущему чату
                    if ((data.sender_id === chatContext.currentUserId &&
                         data.recipient_id === chatContext.recipientId) ||
                        (data.sender_id === chatContext.recipientId &&
                         data.recipient_id === chatContext.currentUserId)) {

                        // Игнорируем собственные сообщения, которые уже были добавлены как временные
                        if (data.sender_id === chatContext.currentUserId) {
                            console.log("Это наше сообщение, пропускаем добавление");
                            return;
                        }

                        // Добавляем сообщение в чат
                        addMessageToChat(data, false);

                        // Помечаем как прочитанное, если это входящее сообщение
                        if (data.sender_id === chatContext.recipientId) {
                            markMessageAsRead(data.id);
                        }

                        // Прокручиваем вниз
                        messageBox.scrollTop = messageBox.scrollHeight;

                        // Воспроизводим звук для входящих сообщений
                        if (data.sender_id === chatContext.recipientId) {
                            playNotificationSound();
                        }
                    }
                });

                // Обработка подтверждения доставки
                window.socket.on('message_delivered', function(data) {
                    console.log('Подтверждение доставки:', data);
                    const tempMsg = document.querySelector(`[data-temp-id="${data.temp_id}"]`);
                    if (tempMsg) {
                        // Заменяем временный ID на реальный
                        tempMsg.id = `message-${data.message_id}`;
                        tempMsg.removeAttribute('data-temp-id');
                        const statusEl = tempMsg.querySelector('.delivery-status');
                        if (statusEl) {
                            statusEl.innerHTML = '<i class="bi bi-check"></i> Доставлено';
                        }
                    }
                });

                // Обработка обновления статуса прочтения
                window.socket.on('message_read', function(data) {
                    console.log('Статус прочтения обновлен:', data);
                    const messageElement = document.getElementById(`message-${data.message_id}`);
                    if (messageElement) {
                        const statusEl = messageElement.querySelector('.delivery-status');
                        if (statusEl) {
                            statusEl.innerHTML = '<i class="bi bi-check2-all"></i> Прочитано';
                            statusEl.classList.remove('text-muted');
                            statusEl.classList.add('text-success');
                        }
                    }
                });

                // Обработка ошибок соединения
                window.socket.on('connect_error', function(error) {
                    console.error("WebSocket connection error:", error);
                    showConnectionWarning(true);
                });

                window.socket.on('connect', function() {
                    console.log("WebSocket reconnected");
                    showConnectionWarning(false);
                    // При переподключении присоединяемся к комнате чата
                    joinChatRoom();
                });

                // Присоединяемся к комнате чата
                joinChatRoom();
            } else {
                console.warn("WebSocket not available, using HTTP only");
            }
        }

        // Функция присоединения к комнате чата
        function joinChatRoom() {
            if (window.socket && window.socket.connected) {
                console.log("Joining chat room for recipient:", chatContext.recipientId);
                window.socket.emit('join_chat', {
                    recipient_id: chatContext.recipientId
                });
            } else {
                console.warn("Socket not connected, cannot join chat room");
            }
        }

        // Функция отправки сообщения
        function sendMessage() {
            const content = messageInput.value.trim();
            if (!content) return;

            // Генерируем временный ID
            const temp_id = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);

            // Создаем временное сообщение
            addMessageToChat({
                id: temp_id,
                sender_id: chatContext.currentUserId,
                recipient_id: chatContext.recipientId,
                sender_name: 'Вы',
                content: content,
                timestamp: new Date().toISOString(),
                is_temp: true,
                files: []
            }, true, temp_id); // Передаем как временное

            // Отправляем через WebSocket
            if (window.socket) {
                window.socket.emit('send_message', {
                    recipient_id: chatContext.recipientId,
                    content: content,
                    temp_id: temp_id  // Передаем временный ID
                });
            } else {
                console.warn("WebSocket not available, message not sent");
            }

            // Очищаем поле ввода
            messageInput.value = '';
            messageInput.focus();
        }

        // Функция обработки загрузки файла
        function handleFileUpload() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            if (!file) return alert('Выберите файл');

            const progressBar = document.querySelector('#file-progress .progress-bar');
            const progressContainer = document.getElementById('file-progress');
            progressContainer.classList.remove('d-none');
            progressBar.style.width = '0%';

            const formData = new FormData();
            formData.append('file', file);
            formData.append('recipient_id', chatContext.recipientId);

            fetch('/upload/{{ recipient.id }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // После загрузки файла, перезагружаем историю, чтобы показать новое сообщение
                    loadChatHistory();
                    playNotificationSound();
                }
            })
            .catch(error => {
                console.error('File upload error:', error);
                showError('Не удалось отправить файл');
            })
            .finally(() => {
                progressContainer.classList.add('d-none');
                fileInput.value = '';
            });
        }

        // Функция добавления сообщения в чат
        function addMessageToChat(data, isTemporary = false, temp_id = null) {
            const isCurrentUser = (data.sender_id == chatContext.currentUserId);
            const messageBoxClass = isCurrentUser ? 'sent-message' : 'received-message';
            const senderName = isCurrentUser ? 'Вы' : chatContext.recipientName;

            // Форматирование содержимого
            let contentHtml = data.content ? `<p class="mb-1">${data.content}</p>` : '';

            // Форматирование файлов
            let fileHtml = '';
            if (data.files && data.files.length > 0) {
                fileHtml = data.files.map(file => `
                    <div class="mb-2">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-file-earmark me-2"></i>
                            <div>
                                <div class="fw-bold">${file.filename}</div>
                                <small class="text-muted">
                                    ${formatFileSize(file.filesize)} -
                                    <a href="/download/${file.id}">Скачать</a>
                                </small>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // Статус доставки
            let statusHtml = '';
            if (isCurrentUser) {
                if (isTemporary) {
                    statusHtml = `<small class="text-muted delivery-status"><i class="bi bi-clock"></i> Отправка...</small>`;
                } else {
                    statusHtml = data.is_read ?
                        `<small class="text-success delivery-status"><i class="bi bi-check2-all"></i> Прочитано</small>` :
                        `<small class="text-muted delivery-status"><i class="bi bi-check"></i> Доставлено</small>`;
                }
            }

            // Форматируем время (добавляем 5 часов для Екатеринбурга)
            const localTime = formatTime(data.timestamp);

            // Создаем элемент сообщения
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-3 ${isCurrentUser ? 'text-end' : ''}`;
            messageDiv.id = `message-${data.id}`;

            if (isTemporary && temp_id) {
                messageDiv.setAttribute('data-temp-id', temp_id);
            }

            messageDiv.innerHTML = `
                <div class="d-flex ${isCurrentUser ? 'justify-content-end' : 'justify-content-start'}">
                    <div class="${messageBoxClass} p-3 rounded">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small><strong>${senderName}</strong></small>
                            <small>${localTime}</small>
                        </div>
                        ${contentHtml}
                        ${fileHtml}
                        ${statusHtml}
                    </div>
                </div>
            `;

            messageBox.appendChild(messageDiv);
            messageBox.scrollTop = messageBox.scrollHeight;
        }

        // Функция пометки сообщения как прочитанного
        function markMessageAsRead(messageId) {
            fetch(`/mark_as_read/${messageId}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        console.log(`Сообщение ${messageId} помечено как прочитанное`);
                        // Обновляем статус в UI
                        updateMessageStatus(messageId, true);
                    }
                })
                .catch(error => console.error('Error marking as read:', error));
        }

        // Функция обновления статуса сообщения в UI
        function updateMessageStatus(messageId, isRead) {
            const messageElement = document.getElementById(`message-${messageId}`);
            if (messageElement) {
                const statusEl = messageElement.querySelector('.delivery-status');
                if (statusEl) {
                    statusEl.innerHTML = isRead ?
                        '<i class="bi bi-check2-all"></i> Прочитано' :
                        '<i class="bi bi-check"></i> Доставлено';

                    if (isRead) {
                        statusEl.classList.remove('text-muted');
                        statusEl.classList.add('text-success');
                    } else {
                        statusEl.classList.remove('text-success');
                        statusEl.classList.add('text-muted');
                    }
                }
            }
        }

        // Функция пометки всех входящих сообщений как прочитанных
        function markAllMessagesAsRead() {
            // Находим все непрочитанные сообщения от этого отправителя
            const unreadMessages = document.querySelectorAll('.received-message .delivery-status');
            unreadMessages.forEach(statusEl => {
                const messageElement = statusEl.closest('.mb-3');
                if (messageElement) {
                    const messageId = messageElement.id.replace('message-', '');
                    if (messageId) {
                        markMessageAsRead(messageId);
                    }
                }
            });
        }

        // Функция для форматирования размера файла
        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // Функция форматирования времени (добавляем 5 часов к UTC)
        function formatTime(utcString) {
            const date = new Date(utcString);
            // Добавляем 5 часов для Екатеринбурга (UTC+5)
            date.setHours(date.getHours() + 5);
            return date.toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Функция воспроизведения звука уведомления
        function playNotificationSound() {
            const audio = document.getElementById('notification-sound');
            if (audio) {
                audio.play().catch(e => console.log('Ошибка воспроизведения звука:', e));
            }
        }

        // Функция показа ошибки
        function showError(message) {
            connectionWarning.textContent = message;
            connectionWarning.classList.remove('d-none');

            setTimeout(() => {
                connectionWarning.classList.add('d-none');
            }, 5000);
        }

        // Функция показа/скрытия предупреждения о соединении
        function showConnectionWarning(show) {
            if (show) {
                connectionWarning.classList.remove('d-none');
            } else {
                connectionWarning.classList.add('d-none');
            }
        }
    });
</script>

<style>
    .sent-message {
        background-color: #d1e7ff;
        border-radius: 15px 15px 0 15px;
        max-width: 75%;
    }

    .received-message {
        background-color: #f1f0f0;
        border-radius: 15px 15px 15px 0;
        max-width: 75%;
    }

    .delivery-status {
        font-size: 0.75rem;
        margin-top: 5px;
        text-align: right;
        transition: all 0.3s ease;
    }

    .delivery-status.text-muted {
        color: #6c757d !important;
    }

    .delivery-status.text-success {
        color: #198754 !important;
    }

    #file-progress {
        transition: width 0.3s ease;
    }

    .message-time {
        opacity: 0.7;
        font-size: 0.8rem;
    }
</style>
{% endblock %}