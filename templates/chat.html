{% extends "base.html" %}
{% block title %}–ß–∞—Ç —Å {{ recipient.fullname }}{% endblock %}

{% block content %}
<div class="row">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-inbox me-2"></i>–í–∞—à–∏ –¥–∏–∞–ª–æ–≥–∏
                </h5>
            </div>
            <div class="card-body p-0">
                {% if conversations %}
                <div class="list-group list-group-flush">
                    {% for message, user in conversations %}
                    <a href="{{ url_for('chat', user_id=user.id) }}"
                       class="list-group-item list-group-item-action {% if user.id == recipient.id %}active-chat{% endif %}"
                       data-last-message-id="{{ message.id }}"
                       data-user-id="{{ user.id }}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="position-relative me-2">
                                    <div class="user-avatar-sm">
                                        <i class="bi bi-person-fill"></i>
                                    </div>
                                    {% if unread_counts[user.id] > 0 %}
                                    <span class="badge bg-danger unread-badge">
                                        {{ unread_counts[user.id] }}
                                    </span>
                                    {% endif %}
                                </div>
                                <div>
                                    <h6 class="mb-0">{{ user.fullname }}</h6>
                                    <small class="conversation-content text-truncate d-block" style="max-width: 200px;">
                                        {% if message.sender_id == current_user.id %}
                                        <strong>–í—ã:</strong>
                                        {% endif %}
                                        {{ message.content|truncate(30) }}
                                    </small>
                                </div>
                            </div>
                            <!-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –î–æ–±–∞–≤–ª–µ–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Å –∫–æ—Ä—Ä–µ–∫—Ü–∏–µ–π —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ -->
                            <small class="message-time" data-utc="{{ message.timestamp.isoformat() }}"></small>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center p-4">
                    <i class="bi bi-chat-left-text" style="font-size: 3rem; color: #6c757d;"></i>
                    <p class="mt-3">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –¢–µ–∫—É—â–∏–π —á–∞—Ç -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="user-avatar me-2">
                        <i class="bi bi-person-fill"></i>
                    </div>
                    <h5 class="mb-0" id="chat-title">–ß–∞—Ç —Å {{ recipient.fullname }}</h5>
                </div>
                <div>
                    <a href="{{ url_for('user_profile', username=recipient.username) }}" class="btn btn-sm btn-outline-secondary me-1" id="profile-link">
                        <i class="bi bi-person"></i> –ü—Ä–æ—Ñ–∏–ª—å
                    </a>
                    <a href="{{ url_for('inbox') }}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-inbox"></i> –í—Ö–æ–¥—è—â–∏–µ
                    </a>
                </div>
            </div>

            <div class="card-body" style="max-height: 60vh; overflow-y: auto;" id="message-box">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </div>

            <div class="card-footer">
                <div class="alert alert-warning d-none mb-3" id="connection-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    –ü–æ—Ç–µ—Ä—è–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è...
                </div>

                <form id="message-form">
                    <div class="input-group mb-3">
                        <textarea class="form-control" name="content" rows="2" id="message-input"
                                 placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required></textarea>
                        <button class="btn btn-primary" type="submit">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                </form>

                <form id="file-form" class="mt-3">
                    <div class="input-group">
                        <input type="file" class="form-control" id="file-input">
                        <button class="btn btn-outline-secondary" type="button" id="file-button">
                            <i class="bi bi-paperclip"></i> –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª
                        </button>
                    </div>
                    <small class="text-muted">–§–∞–π–ª—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–µ –±–æ–ª–µ–µ {{ config['FILE_LIFETIME'] }} –¥–Ω–µ–π</small>
                    <div class="progress mt-2 d-none" id="file-progress" style="height: 5px;">
                        <div class="progress-bar" role="progressbar" style="width: 0%;"></div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Initializing chat...");

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —á–∞—Ç–∞
        window.chatContext = {
            currentUserId: {{ current_user.id }},
            recipientId: {{ recipient.id }},
            recipientName: "{{ recipient.fullname }}",
            recipientUsername: "{{ recipient.username }}"
        };

        // –≠–ª–µ–º–µ–Ω—Ç—ã UI
        const messageBox = document.getElementById('message-box');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const fileButton = document.getElementById('file-button');
        const connectionWarning = document.getElementById('connection-warning');
        const profileLink = document.getElementById('profile-link');
        const chatTitle = document.getElementById('chat-title');
        let currentChatRoom = null;

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∞–≤–∏—à –¥–ª—è textarea
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
        loadChatHistory();

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            sendMessage();
        });
        fileButton.addEventListener('click', handleFileUpload);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebSocket
        initWebSocket();

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ –≤ —Å–ø–∏—Å–∫–µ —á–∞—Ç–æ–≤
        updateAllTimes();

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –¥–∏–∞–ª–æ–≥–∞–º –≤ —Å–ø–∏—Å–∫–µ
        document.querySelectorAll('.list-group-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const userId = this.dataset.userId;
                if (userId && userId != chatContext.recipientId) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º URL –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                    window.history.pushState(null, null, `/chat/${userId}`);
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–π —á–∞—Ç
                    loadNewChat(userId);
                }
            });
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –±—Ä–∞—É–∑–µ—Ä–∞
        window.addEventListener('popstate', function() {
            const pathParts = window.location.pathname.split('/');
            const userId = pathParts[pathParts.length - 1];
            if (userId && !isNaN(userId)) {
                loadNewChat(parseInt(userId));
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
        function loadNewChat(userId) {
            console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ID: ${userId}`);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            messageBox.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞
            document.querySelector('.card-header').classList.add('chat-header-updating');

            // –ü–æ–º–µ—á–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
            if (chatContext.recipientId) {
                markAllMessagesAsRead(chatContext.recipientId);
            }

            // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ç–µ–∫—É—â–µ–π –∫–æ–º–Ω–∞—Ç—ã
            if (window.socket && currentChatRoom) {
                window.socket.emit('leave_room', {room: currentChatRoom});
                console.log("–í—ã—Ö–æ–¥ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∫–æ–º–Ω–∞—Ç—ã —á–∞—Ç–∞:", currentChatRoom);
                currentChatRoom = null;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤ —Å–ø–∏—Å–∫–µ
            document.querySelectorAll('.list-group-item').forEach(item => {
                item.classList.remove('active-chat');
                if (parseInt(item.dataset.userId) === userId) {
                    item.classList.add('active-chat');
                }
            });

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–æ–≤–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            fetch(`/user_info/${userId}`)
                .then(response => response.json())
                .then(data => {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —á–∞—Ç–∞
                    chatContext.recipientId = userId;
                    chatContext.recipientName = data.fullname;
                    chatContext.recipientUsername = data.username;

                    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞
                    chatTitle.textContent = `–ß–∞—Ç —Å ${data.fullname}`;

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å
                    if (profileLink) {
                        profileLink.href = `/user_profile/${data.username}`;
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º title —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                    document.title = `–ß–∞—Ç —Å ${data.fullname}`;

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞
                    const fileForm = document.getElementById('file-form');
                    if (fileForm) {
                        fileForm.action = `/upload/${userId}`;
                    }

                    // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –Ω–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç–µ —á–∞—Ç–∞
                    joinChatRoom();

                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                    updatePresence();

                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
                    loadChatHistory();

                    // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                    setTimeout(() => {
                        document.querySelector('.card-header').classList.remove('chat-header-updating');
                    }, 300);
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:', error);
                    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ');
                    document.querySelector('.card-header').classList.remove('chat-header-updating');
                });
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        function updatePresence() {
            if (window.socket && chatContext.recipientId) {
                window.socket.emit('update_presence', {
                    recipient_id: chatContext.recipientId
                });
                console.log("üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä");
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–º–µ—Ç–∫–∏ –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
        function markAllMessagesAsRead(senderId) {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø–æ–º–µ—Ç–∫–∏ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
            fetch(`/mark_all_as_read/${senderId}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        console.log(`–í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç ${senderId} –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ`);
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏
                        updateUnreadBadge(senderId, 0);
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫
                        updateGlobalUnreadCount();
                    }
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞ –ø–æ–º–µ—Ç–∫–∏ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö:', error));
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –≤ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏
        function updateUnreadBadge(userId, count) {
            const conversation = document.querySelector(`.list-group-item[data-user-id="${userId}"]`);
            if (conversation) {
                const badge = conversation.querySelector('.unread-badge');

                if (count > 0) {
                    if (badge) {
                        badge.textContent = count;
                    } else {
                        const newBadge = document.createElement('span');
                        newBadge.className = 'badge bg-danger unread-badge';
                        newBadge.textContent = count;
                        const container = conversation.querySelector('.position-relative');
                        if (container) {
                            container.appendChild(newBadge);
                        }
                    }
                } else if (badge) {
                    badge.remove();
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        function updateGlobalUnreadCount() {
            fetch('/unread_count')
                .then(response => response.json())
                .then(data => {
                    const badge = document.querySelector('.unread-count-badge');
                    if (badge) {
                        if (data.count > 0) {
                            badge.textContent = data.count;
                            badge.style.display = 'inline-block';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
        function loadChatHistory() {
            fetch(`/chat/history/${chatContext.recipientId}`)
                .then(response => response.json())
                .then(messages => {
                    messageBox.innerHTML = ''; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                    messages.forEach(msg => {
                        addMessageToChat({
                            id: msg.id,
                            sender_id: msg.sender_id,
                            recipient_id: msg.recipient_id,
                            sender_name: msg.sender_name,
                            content: msg.content,
                            timestamp: msg.timestamp,
                            is_read: msg.is_read,
                            files: msg.files
                        }, false); // –ù–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    });
                    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
                    messageBox.scrollTop = messageBox.scrollHeight;

                    // –ü–æ–º–µ—á–∞–µ–º –≤—Å–µ –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
                    markAllMessagesAsRead(chatContext.recipientId);
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
                    showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π');
                });
        }

        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ —á–∞—Ç–∞
        function joinChatRoom() {
            if (window.socket && window.socket.connected) {
                // –§–æ—Ä–º–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –∫–æ–º–Ω–∞—Ç—ã –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
                const room = getChatRoomName(chatContext.currentUserId, chatContext.recipientId);

                console.log("–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ —á–∞—Ç–∞:", room);

                // –í—ã—Ö–æ–¥–∏–º –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∫–æ–º–Ω–∞—Ç—ã (–µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å –∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –Ω–æ–≤–æ–π)
                if (currentChatRoom && currentChatRoom !== room) {
                    window.socket.emit('leave_room', {room: currentChatRoom});
                    console.log("–í—ã—Ö–æ–¥ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∫–æ–º–Ω–∞—Ç—ã:", currentChatRoom);
                }

                // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –Ω–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç–µ
                window.socket.emit('join_chat', {
                    recipient_id: chatContext.recipientId,
                    room: room
                });

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –∫–æ–º–Ω–∞—Ç—É
                currentChatRoom = room;
                console.log("–£—Å–ø–µ—à–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ:", currentChatRoom);
            } else {
                console.warn("–°–æ–∫–µ—Ç –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω, –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ —á–∞—Ç–∞");
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–º–µ–Ω–∏ –∫–æ–º–Ω–∞—Ç—ã –¥–ª—è —á–∞—Ç–∞
        function getChatRoomName(userId1, userId2) {
            const id1 = parseInt(userId1);
            const id2 = parseInt(userId2);
            const ids = [id1, id2].sort((a, b) => a - b);
            return `chat_${ids[0]}_${ids[1]}`;
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        function sendMessage() {
            const content = messageInput.value.trim();
            if (!content) return;

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π ID
            const temp_id = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);

            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            addMessageToChat({
                id: temp_id,
                sender_id: chatContext.currentUserId,
                recipient_id: chatContext.recipientId,
                sender_name: '–í—ã',
                content: content,
                timestamp: new Date().toISOString(),
                is_temp: true,
                files: []
            }, true, temp_id); // –ü–µ—Ä–µ–¥–∞–µ–º –∫–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ WebSocket
            if (window.socket) {
                window.socket.emit('send_message', {
                    recipient_id: chatContext.recipientId,
                    content: content,
                    temp_id: temp_id,  // –ü–µ—Ä–µ–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π ID
                    room: currentChatRoom  // –£–∫–∞–∑—ã–≤–∞–µ–º —Ü–µ–ª–µ–≤—É—é –∫–æ–º–Ω–∞—Ç—É
                });
            } else {
                console.warn("WebSocket –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ");
            }

            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            messageInput.value = '';
            messageInput.focus();
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
        function handleFileUpload() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            if (!file) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');

            const progressBar = document.querySelector('#file-progress .progress-bar');
            const progressContainer = document.getElementById('file-progress');
            progressContainer.classList.remove('d-none');
            progressBar.style.width = '0%';

            const formData = new FormData();
            formData.append('file', file);
            formData.append('recipient_id', chatContext.recipientId);

            fetch(`/upload/${chatContext.recipientId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    loadChatHistory();
                    playNotificationSound();
                }
            })
            .catch(error => {
                console.error('File upload error:', error);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª');
            })
            .finally(() => {
                progressContainer.classList.add('d-none');
                fileInput.value = '';
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
        function addMessageToChat(data, isTemporary = false, temp_id = null) {
            const isCurrentUser = (data.sender_id == chatContext.currentUserId);
            const messageBoxClass = isCurrentUser ? 'sent-message' : 'received-message';
            const senderName = isCurrentUser ? '–í—ã' : chatContext.recipientName;

            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
            let contentHtml = data.content ? `<p class="mb-1">${data.content}</p>` : '';

            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
            let fileHtml = '';
            if (data.files && data.files.length > 0) {
                fileHtml = data.files.map(file => `
                    <div class="mb-2">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-file-earmark me-2"></i>
                            <div>
                                <div class="fw-bold">${file.filename}</div>
                                <small class="text-muted">
                                    ${formatFileSize(file.filesize)} -
                                    <a href="/download/${file.id}">–°–∫–∞—á–∞—Ç—å</a>
                                </small>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // –°—Ç–∞—Ç—É—Å –¥–æ—Å—Ç–∞–≤–∫–∏
            let statusHtml = '';
            if (isCurrentUser) {
                if (isTemporary) {
                    statusHtml = `<small class="text-muted delivery-status"><i class="bi bi-clock"></i> –û—Ç–ø—Ä–∞–≤–∫–∞...</small>`;
                } else {
                    statusHtml = data.is_read ?
                        `<small class="text-success delivery-status"><i class="bi bi-check2-all"></i> –ü—Ä–æ—á–∏—Ç–∞–Ω–æ</small>` :
                        `<small class="text-muted delivery-status"><i class="bi bi-check"></i> –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</small>`;
                }
            }

            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è —Å —É—á–µ—Ç–æ–º –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
            const localTime = formatTime(data.timestamp);

            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-3 ${isCurrentUser ? 'text-end' : ''}`;
            messageDiv.id = `message-${data.id}`;

            if (isTemporary && temp_id) {
                messageDiv.setAttribute('data-temp-id', temp_id);
            }

            messageDiv.innerHTML = `
                <div class="d-flex ${isCurrentUser ? 'justify-content-end' : 'justify-content-start'}">
                    <div class="${messageBoxClass} p-3 rounded">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small><strong>${senderName}</strong></small>
                            <small>${localTime}</small>
                        </div>
                        ${contentHtml}
                        ${fileHtml}
                        ${statusHtml}
                    </div>
                </div>
            `;

            messageBox.appendChild(messageDiv);
            messageBox.scrollTop = messageBox.scrollHeight;
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–º–µ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ
        function markMessageAsRead(messageId) {
            fetch(`/mark_as_read/${messageId}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        console.log(`–°–æ–æ–±—â–µ–Ω–∏–µ ${messageId} –ø–æ–º–µ—á–µ–Ω–æ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ`);
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ UI
                        updateMessageStatus(messageId, true);

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ –ª–µ–≤–æ–π –ø–∞–Ω–µ–ª–∏
                        const userId = chatContext.recipientId;
                        const currentBadge = document.querySelector(`.list-group-item[data-user-id="${userId}"] .unread-badge`);
                        const currentCount = currentBadge ? parseInt(currentBadge.textContent) - 1 : 0;
                        updateUnreadBadge(userId, currentCount);

                        // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫
                        updateGlobalUnreadCount();
                    }
                })
                .catch(error => console.error('Error marking as read:', error));
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ UI
        function updateMessageStatus(messageId, isRead) {
            const messageElement = document.getElementById(`message-${messageId}`);
            if (messageElement) {
                const statusEl = messageElement.querySelector('.delivery-status');
                if (statusEl) {
                    statusEl.innerHTML = isRead ?
                        '<i class="bi bi-check2-all"></i> –ü—Ä–æ—á–∏—Ç–∞–Ω–æ' :
                        '<i class="bi bi-check"></i> –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ';

                    if (isRead) {
                        statusEl.classList.remove('text-muted');
                        statusEl.classList.add('text-success');
                    } else {
                        statusEl.classList.remove('text-success');
                        statusEl.classList.add('text-muted');
                    }
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ (–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–ª—è —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞)
        function formatTime(utcString) {
            const date = new Date(utcString);
            return date.toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫ –≤ —Å–ø–∏—Å–∫–µ —á–∞—Ç–æ–≤
        function updateAllTimes() {
            document.querySelectorAll('.message-time[data-utc]').forEach(el => {
                const utcTime = el.getAttribute('data-utc');
                if (utcTime) {
                    const date = new Date(utcTime);

                    // –ö–æ—Ä—Ä–µ–∫—Ü–∏—è —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞: –¥–æ–±–∞–≤–ª—è–µ–º 5 —á–∞—Å–æ–≤ –¥–ª—è –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥–∞ (UTC+5)
                    const localTime = new Date(date.getTime() + 5 * 60 * 60 * 1000);

                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –≤—Ä–µ–º—è (—á–∞—Å—ã:–º–∏–Ω—É—Ç—ã)
                    el.textContent = localTime.toLocaleTimeString('ru-RU', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function playNotificationSound() {
            const audio = document.getElementById('notification-sound');
            if (audio) {
                audio.play().catch(e => console.log('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞:', e));
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–∫–∏
        function showError(message) {
            connectionWarning.textContent = message;
            connectionWarning.classList.remove('d-none');

            setTimeout(() => {
                connectionWarning.classList.add('d-none');
            }, 5000);
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏
        function showConnectionWarning(show) {
            if (show) {
                connectionWarning.classList.remove('d-none');
            } else {
                connectionWarning.classList.add('d-none');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebSocket
        function initWebSocket() {
            if (window.socket) {
                console.log("WebSocket –¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                window.socket.on('connect_error', function(error) {
                    console.error("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WebSocket:", error);
                    showConnectionWarning(true);
                });

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                window.socket.on('connect', function() {
                    console.log("WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω/–ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω");
                    showConnectionWarning(false);

                    // –ü—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ —á–∞—Ç–∞
                    joinChatRoom();

                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–∏
                    updatePresence();

                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —á–∞—Ç–∞
                    loadChatHistory();
                });

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                window.socket.on('new_message', function(data) {
                    console.log("–ü–æ–ª—É—á–µ–Ω–æ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:", data);

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫ —Ç–µ–∫—É—â–µ–º—É —á–∞—Ç—É
                    if ((data.sender_id === chatContext.currentUserId &&
                         data.recipient_id === chatContext.recipientId) ||
                        (data.sender_id === chatContext.recipientId &&
                         data.recipient_id === chatContext.currentUserId)) {

                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –±—ã–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ
                        if (data.sender_id === chatContext.currentUserId) {
                            console.log("–≠—Ç–æ –Ω–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ");
                            return;
                        }

                        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
                        addMessageToChat(data, false);

                        // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ, –µ—Å–ª–∏ —ç—Ç–æ –≤—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        if (data.sender_id === chatContext.recipientId) {
                            markMessageAsRead(data.id);
                        }

                        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
                        messageBox.scrollTop = messageBox.scrollHeight;

                        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ –¥–ª—è –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                        if (data.sender_id === chatContext.recipientId) {
                            playNotificationSound();
                        }
                    }
                });

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏
                window.socket.on('message_delivered', function(data) {
                    console.log('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–æ—Å—Ç–∞–≤–∫–∏:', data);
                    const tempMsg = document.querySelector(`[data-temp-id="${data.temp_id}"]`);
                    if (tempMsg) {
                        // –ó–∞–º–µ–Ω—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π ID –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π
                        tempMsg.id = `message-${data.message_id}`;
                        tempMsg.removeAttribute('data-temp-id');
                        const statusEl = tempMsg.querySelector('.delivery-status');
                        if (statusEl) {
                            statusEl.innerHTML = '<i class="bi bi-check"></i> –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ';
                        }
                    }
                });

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ—á—Ç–µ–Ω–∏—è
                window.socket.on('message_read', function(data) {
                    console.log('–°—Ç–∞—Ç—É—Å –ø—Ä–æ—á—Ç–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω:', data);
                    const messageElement = document.getElementById(`message-${data.message_id}`);
                    if (messageElement) {
                        const statusEl = messageElement.querySelector('.delivery-status');
                        if (statusEl) {
                            statusEl.innerHTML = '<i class="bi bi-check2-all"></i> –ü—Ä–æ—á–∏—Ç–∞–Ω–æ';
                            statusEl.classList.remove('text-muted');
                            statusEl.classList.add('text-success');
                        }
                    }
                });

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è
                window.socket.on('update_presence', function(data) {
                    console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è:', data);
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    updateOnlineStatus(data.user_id, true);
                });

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                window.socket.on('user_disconnected', function(data) {
                    console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª—é—á–∏–ª—Å—è:', data);
                    updateOnlineStatus(data.user_id, false);
                });

                // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ —á–∞—Ç–∞
                joinChatRoom();
            } else {
                console.warn("WebSocket –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ HTTP");
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –æ–Ω–ª–∞–π–Ω
        function updateOnlineStatus(userId, isOnline) {
            const userElements = document.querySelectorAll(`[data-user-id="${userId}"]`);
            userElements.forEach(element => {
                const statusBadge = element.querySelector('.online-badge');
                if (statusBadge) {
                    statusBadge.style.display = isOnline ? 'block' : 'none';
                }
            });
        }
    });
</script>
{% endblock %}

{% block styles %}
<style>
    .sent-message {
        background-color: #d1e7ff;
        border-radius: 15px 15px 0 15px;
        max-width: 75%;
    }

    .received-message {
        background-color: #f1f0f0;
        border-radius: 15px 15px 15px 0;
        max-width: 75%;
    }

    .delivery-status {
        font-size: 0.75rem;
        margin-top: 5px;
        text-align: right;
        transition: all 0.3s ease;
    }

    .delivery-status.text-muted {
        color: #6c757d !important;
    }

    .delivery-status.text-success {
        color: #198754 !important;
    }

    #file-progress {
        transition: width 0.3s ease;
    }

    .message-time {
        opacity: 0.7;
        font-size: 0.8rem;
    }

    /* –£—Å–∏–ª–µ–Ω–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞ */
    .active-chat {
        background-color: #e0f0ff !important;
        border-left: 4px solid #0d6efd !important;
        font-weight: 500;
        z-index: 1;
        box-shadow: 0 0 10px rgba(13, 110, 253, 0.2);
    }

    .list-group-item {
        border-radius: 0;
        border-left: none;
        border-right: none;
        transition: all 0.3s ease;
    }

    .user-avatar-sm {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background-color: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    .unread-badge {
        position: absolute;
        top: -5px;
        right: -5px;
    }

    .online-badge {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 10px;
        height: 10px;
        background-color: #28a745;
        border-radius: 50%;
        border: 2px solid white;
        display: none;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
    .chat-header-updating {
        opacity: 0.7;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
    }
</style>
{% endblock %}