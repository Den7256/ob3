<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è —Å–µ—Ç—å{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" />
    <style>
        .post-card { margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .message-box { max-height: 60vh; overflow-y: auto; padding: 15px; background-color: #f8f9fa; border-radius: 8px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #6c757d; display: flex; align-items: center; justify-content: center; color: white; }
        .sent-message { background-color: #d1ecf1; border-radius: 10px; padding: 10px; margin-bottom: 10px; max-width: 80%; margin-left: auto; }
        .received-message { background-color: #f8d7da; border-radius: 10px; padding: 10px; margin-bottom: 10px; max-width: 80%; margin-right: auto; }
        .navbar { background-color: #343a40; }
        .footer { background-color: #f8f9fa; padding: 20px 0; margin-top: 30px; }
        .unread-badge { position: absolute; top: 5px; right: 5px; font-size: 0.6rem; }
        .online-badge { position: absolute; bottom: 0; right: 0; width: 10px; height: 10px; background-color: #0f0; border-radius: 50%; border: 2px solid white; }

        /* –°—Ç–∏–ª—å –¥–ª—è –ª–æ–≥–æ—Ç–∏–ø –≤–Ω—É—Ç—Ä–∏ –Ω–∞–≤–±–∞—Ä–∞ */
        .navbar-brand {
            display: flex;
            align-items: center;
        }
        .navbar-brand img {
            height: 40px;
            margin-right: 10px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 350px;
        }

        .notification {
            background: white;
            border-left: 4px solid #0d6efd;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            animation: fadeIn 0.3s, fadeOut 0.3s 4.7s;
        }

        .notification-icon {
            font-size: 24px;
            margin-right: 15px;
            color: #0d6efd;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }
    </style>
</head>
<body>
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º –≤–Ω—É—Ç—Ä–∏ -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <img src="{{ url_for('static', filename='image/ob3.png') }}" alt="–û–±–õ–û" />
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}"><i class="bi bi-house-door"></i> –õ–µ–Ω—Ç–∞</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('users') }}"><i class="bi bi-people"></i> –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link position-relative" href="{{ url_for('inbox') }}">
                            <i class="bi bi-chat-text"></i> –°–æ–æ–±—â–µ–Ω–∏—è
                            {% if unread_messages_count > 0 %}
                            <span class="badge bg-danger unread-badge">{{ unread_messages_count }}</span>
                            {% endif %}
                        </a>
                    </li>
                    {% if session.get('is_admin') %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('admin_panel') }}"><i class="bi bi-shield-lock"></i> –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
                    </li>
                    {% endif %}
                </ul>
                <div class="d-flex align-items-center">
                    {% if current_user %}
                    <span class="navbar-text me-3">
                        <i class="bi bi-person-circle me-1"></i> {{ current_user.fullname }}
                    </span>
                    <a href="{{ url_for('user_profile', username=current_user.username) }}" class="btn btn-outline-light btn-sm">
                        <i class="bi bi-person"></i> –ü—Ä–æ—Ñ–∏–ª—å
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div class="notification-container" id="notification-container"></div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="container my-4">
        {% block content %}{% endblock %}
    </div>

    <!-- –ü–æ–¥–≤–∞–ª -->
    <footer class="footer">
        <div class="container text-center">
            <p class="mb-0">–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å–µ—Ç—å –û–ë3 ¬© {{ current_year }}</p>
            <small class="text-muted">–§–∞–π–ª—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–µ –±–æ–ª–µ–µ {{ config['FILE_LIFETIME'] }} –¥–Ω–µ–π</small>
        </div>
    </footer>

    <!-- –°–∫—Ä—ã—Ç—ã–π –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <audio id="notification-sound" preload="auto">
        <source src="{{ url_for('static', filename='sounds/notification.mp3') }}" type="audio/mpeg">
    </audio>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    {% if 'user_id' in session %}
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ —Å–æ–∫–µ—Ç–∞
        window.socket = io({
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionAttempts: Infinity,
            randomizationFactor: 0.5,
            timeout: 20000,
            withCredentials: true
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π —Å–æ–∫–µ—Ç–∞
        window.socket.on('connect', function() {
            console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');

            // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –ª–∏—á–Ω–æ–π –∫–æ–º–Ω–∞—Ç–µ
            if (window.currentUserId) {
                window.socket.emit('join_room', { room: `user_${window.currentUserId}` });
                console.log(`üë§ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –ª–∏—á–Ω–æ–π –∫–æ–º–Ω–∞—Ç–µ: user_${window.currentUserId}`);
            }
        });

        window.socket.on('connect_error', function(error) {
            console.error('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WebSocket:', error);
        });

        window.socket.on('disconnect', function(reason) {
            console.log('‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω:', reason);
        });

        window.socket.on('new_message_notification', function(data) {
            console.log('üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏:', data);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification(data);

            // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            playNotificationSound();

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
            updateUnreadCount();
        });

        window.socket.on('online_users_update', function(data) {
            console.log('üë• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –æ–Ω–ª–∞–π–Ω-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', data.users);
            updateOnlineUsers(data.users);
        });

        window.socket.on('error', function(error) {
            console.error('‚ö†Ô∏è –û—à–∏–±–∫–∞ WebSocket:', error);
        });

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showNotification(data) {
            const container = document.getElementById('notification-container');
            if (!container) return;

            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const maxLength = 100;
            let content = data.content;
            if (content.length > maxLength) {
                content = content.substring(0, maxLength) + '...';
            }

            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="bi bi-chat-text"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
                    <div>–û—Ç ${data.sender_name}: ${content}</div>
                    <small class="text-muted">${new Date().toLocaleTimeString()}</small>
                </div>
            `;

            container.appendChild(notification);

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // –§—É–Ω–∫—Ü–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function playNotificationSound() {
            const audio = document.getElementById('notification-sound');
            if (audio) {
                audio.play().catch(e => console.log('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞:', e));
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
        function updateUnreadCount() {
            fetch('/unread_count')
                .then(response => response.json())
                .then(data => {
                    const badge = document.querySelector('.nav-link[href*="inbox"] .badge');
                    if (data.count > 0) {
                        if (badge) {
                            badge.textContent = data.count;
                        } else {
                            const link = document.querySelector('.nav-link[href*="inbox"]');
                            if (link) {
                                const newBadge = document.createElement('span');
                                newBadge.className = 'badge bg-danger unread-badge';
                                newBadge.textContent = data.count;
                                link.appendChild(newBadge);
                            }
                        }
                    } else if (badge) {
                        badge.remove();
                    }
                });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –æ–Ω–ª–∞–π–Ω-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function updateOnlineUsers(users) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ —Å–ø–∏—Å–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            document.querySelectorAll('.user-status').forEach(element => {
                const userId = element.dataset.userId;
                const isOnline = users.some(user => user.id == userId);

                if (isOnline) {
                    element.innerHTML = '<span class="badge bg-success">–û–Ω–ª–∞–π–Ω</span>';
                } else {
                    element.innerHTML = '<span class="badge bg-secondary">–û—Ñ–ª–∞–π–Ω</span>';
                }
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ —á–∞—Ç–∞—Ö
            document.querySelectorAll('.user-avatar').forEach(avatar => {
                const userId = avatar.dataset.userId;
                const isOnline = users.some(user => user.id == userId);

                const badge = avatar.querySelector('.online-badge');
                if (isOnline) {
                    if (!badge) {
                        const onlineBadge = document.createElement('div');
                        onlineBadge.className = 'online-badge';
                        avatar.appendChild(onlineBadge);
                    }
                } else if (badge) {
                    badge.remove();
                }
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            {% if current_user %}
            window.currentUserId = {{ current_user.id }};
            {% endif %}

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
            updateUnreadCount();
        });
    </script>
    {% endif %}

    {% block scripts %}{% endblock %}
</body>
</html>