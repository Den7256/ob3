{% extends "base.html" %}
{% block title %}–í—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        window.currentUserId = {{ current_user.id }};

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Å –∫–æ—Ä—Ä–µ–∫—Ü–∏–µ–π —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
        function formatInboxTime(utcString) {
            const date = new Date(utcString);
            // –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –¥–ª—è –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥–∞ (UTC+5)
            date.setHours(date.getHours() + 5);

            return date.toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        function updateAllTimes() {
            document.querySelectorAll('.message-time[data-utc]').forEach(el => {
                const utcTime = el.getAttribute('data-utc');
                if (utcTime) {
                    el.textContent = formatInboxTime(utcTime);
                    el.removeAttribute('data-utc');
                }
            });
        }

        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
        if (window.socket) {
            window.socket.on('inbox_update', function(data) {
                console.log('üîî –ü–æ–ª—É—á–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤:', data);

                // –ï—Å–ª–∏ —ç—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (data.user_id === window.currentUserId) {
                    // –ï—Å–ª–∏ —ç—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ—á—Ç–µ–Ω–∏—è
                    if (data.is_read_update) {
                        updateConversationReadStatus(data.sender_id);
                    }
                    // –ï—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    else {
                        updateConversation(data);
                    }
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ—á—Ç–µ–Ω–∏—è –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ
        function updateConversationReadStatus(sender_id) {
            const conversation = document.querySelector(`.list-group-item[data-user-id="${sender_id}"]`);
            if (conversation) {
                const badge = conversation.querySelector('.unread-badge');
                if (badge) {
                    const count = parseInt(badge.textContent) - 1;
                    if (count > 0) {
                        badge.textContent = count;
                    } else {
                        badge.remove();
                    }
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –ø—Ä–∏ –Ω–æ–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
        function updateConversation(data) {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
            const userId = data.sender_id === window.currentUserId ?
                           data.recipient_id :
                           data.sender_id;

            // –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ä–∞–∑–≥–æ–≤–æ—Ä
            const conversation = document.querySelector(`.list-group-item[data-user-id="${userId}"]`);

            if (conversation) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                const contentElement = conversation.querySelector('.conversation-content');
                if (contentElement) {
                    const prefix = data.sender_id === window.currentUserId ? '<strong>–í—ã:</strong> ' : '';
                    contentElement.innerHTML = `
                        <small>
                            ${prefix}${data.content.substring(0, 50)}${data.content.length > 50 ? '...' : ''}
                        </small>
                    `;
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è —Å –∫–æ—Ä—Ä–µ–∫—Ü–∏–µ–π —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
                const timeElement = conversation.querySelector('.message-time');
                if (timeElement) {
                    timeElement.textContent = formatInboxTime(data.timestamp);
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                if (data.sender_id !== window.currentUserId) {
                    const badge = conversation.querySelector('.unread-badge');
                    if (badge) {
                        const count = parseInt(badge.textContent) + 1;
                        badge.textContent = count;
                    } else {
                        const newBadge = document.createElement('span');
                        newBadge.className = 'badge bg-danger unread-badge';
                        newBadge.textContent = '1';
                        conversation.querySelector('.position-relative').appendChild(newBadge);
                    }
                }

                // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —Ä–∞–∑–≥–æ–≤–æ—Ä –Ω–∞–≤–µ—Ä—Ö
                const listGroup = conversation.parentElement;
                listGroup.insertBefore(conversation, listGroup.firstChild);
            } else {
                // –ï—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≤–µ—Å—å —Å–ø–∏—Å–æ–∫
                loadInboxList();
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
        function loadInboxList() {
            fetch('/inbox')
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newList = doc.querySelector('.list-group');
                    if (newList) {
                        const container = document.querySelector('.list-group');
                        container.parentNode.replaceChild(newList, container);
                        // –ü–æ–≤—Ç–æ—Ä–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                        initConversationHover();
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
                        updateAllTimes();
                    }
                });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –Ω–∞–≤–µ–¥–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤
        function initConversationHover() {
            document.querySelectorAll('.list-group-item').forEach(item => {
                item.addEventListener('mouseenter', function() {
                    const messageId = this.dataset.lastMessageId;
                    const recipientId = this.dataset.userId;

                    // –ü–æ–º–µ—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –ø–æ–ª—É—á–∞—Ç–µ–ª—å
                    if (messageId && recipientId && recipientId == window.currentUserId) {
                        fetch(`/mark_as_read/${messageId}`, { method: 'POST' })
                            .then(() => {
                                // –£–¥–∞–ª—è–µ–º –±–µ–π–¥–∂ –ø–æ—Å–ª–µ –ø–æ–º–µ—Ç–∫–∏ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ
                                const badge = this.querySelector('.unread-badge');
                                if (badge) {
                                    badge.remove();
                                }
                            })
                            .catch(error => console.error('–û—à–∏–±–∫–∞ –ø–æ–º–µ—Ç–∫–∏ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ:', error));
                    }
                });
            });
        }

        // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        updateAllTimes();  // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
        initConversationHover();
    });
</script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-inbox me-2"></i>–í—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                </h5>
            </div>
            <div class="card-body">
                {% if conversations %}
                <div class="list-group">
                    {% for message, user in conversations %}
                    <a href="{{ url_for('chat', user_id=user.id) }}"
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                       data-last-message-id="{{ message.id }}"
                       data-user-id="{{ user.id }}">
                        <div class="d-flex align-items-center w-100">
                            <div class="position-relative">
                                <div class="user-avatar me-3">
                                    <i class="bi bi-person-fill"></i>
                                </div>
                                {% if unread_counts[user.id] > 0 %}
                                <span class="badge bg-danger unread-badge">
                                    {{ unread_counts[user.id] }}
                                </span>
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between">
                                    <h6 class="mb-1">{{ user.fullname }}</h6>
                                    <!-- –î–æ–±–∞–≤–ª–µ–Ω –∞—Ç—Ä–∏–±—É—Ç data-utc –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ -->
                                    <small class="message-time" data-utc="{{ message.timestamp.isoformat() }}">
                                        {{ message.timestamp.strftime('%d.%m.%Y %H:%M') }}
                                    </small>
                                </div>
                                <p class="mb-0 conversation-content">
                                    <small>
                                        {% if message.sender_id == current_user.id %}
                                        <strong>–í—ã:</strong>
                                        {% endif %}
                                        {{ message.content|truncate(50) }}
                                    </small>
                                </p>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-chat-left-text" style="font-size: 3rem; color: #6c757d;"></i>
                    <h5 class="mt-3">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</h5>
                    <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤. –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ —Å –∫–æ–ª–ª–µ–≥–∞–º–∏!</p>
                    <a href="{{ url_for('users') }}" class="btn btn-primary">
                        <i class="bi bi-people me-2"></i>–ù–∞–π—Ç–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    .list-group-item {
        transition: all 0.3s ease;
        border-left: 3px solid transparent;
    }

    .list-group-item:hover {
        background-color: #f8f9fa;
        border-left-color: #0d6efd;
        transform: translateX(5px);
    }

    .conversation-content {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .position-relative {
        position: relative;
    }

    .unread-badge {
        position: absolute;
        top: -5px;
        right: -5px;
    }
</style>
{% endblock %}